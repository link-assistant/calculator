name: Update Screenshots

on:
  push:
    branches:
      - main
    paths:
      - 'web/**'
      - 'src/**'
      - 'data/examples.lino'
  workflow_dispatch:
    inputs:
      update_readme:
        description: 'Update README.md with new screenshots'
        type: boolean
        default: true
      update_use_cases:
        description: 'Update USE-CASES.md with new screenshots'
        type: boolean
        default: true

jobs:
  update-screenshots:
    name: Update Screenshots
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Build WASM package
        run: wasm-pack build --target web --out-dir web/public/pkg

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install web dependencies
        working-directory: web
        run: npm ci || npm install

      - name: Install Playwright browsers
        working-directory: web
        run: npx playwright install chromium

      - name: Build web app
        working-directory: web
        run: npm run build

      - name: Start preview server
        working-directory: web
        run: |
          npm run preview &
          sleep 5

      - name: Take screenshots
        working-directory: web
        run: |
          npx playwright test e2e/screenshots.spec.ts --reporter=list || true

      - name: Copy screenshots to docs
        run: |
          mkdir -p docs/use-cases
          mkdir -p docs/screenshots
          # Copy use-cases screenshots (generated by Playwright)
          if [ -d "docs/use-cases" ] && ls docs/use-cases/*.png 1>/dev/null 2>&1; then
            # Copy relevant screenshots for README
            cp docs/use-cases/01-initial-state.png docs/screenshots/calculator-main.png 2>/dev/null || true
            cp docs/use-cases/02-simple-arithmetic.png docs/screenshots/calculator-arithmetic.png 2>/dev/null || true
            cp docs/use-cases/03-currency-conversion.png docs/screenshots/calculator-currency.png 2>/dev/null || true
            cp docs/use-cases/08-datetime.png docs/screenshots/calculator-datetime.png 2>/dev/null || true
            cp docs/use-cases/09-parentheses.png docs/screenshots/calculator-parentheses.png 2>/dev/null || true
          fi

      - name: Check for changes
        id: changes
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git commit -m "chore: update screenshots [skip ci]"
          git push
